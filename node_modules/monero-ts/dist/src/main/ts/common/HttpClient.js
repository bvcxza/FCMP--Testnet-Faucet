"use strict";var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports, "__esModule", { value: true });exports.default = void 0;var _GenUtils = _interopRequireDefault(require("./GenUtils"));
var _LibraryUtils = _interopRequireDefault(require("./LibraryUtils"));
var _ThreadPool = _interopRequireDefault(require("./ThreadPool"));
var _promiseThrottle = _interopRequireDefault(require("promise-throttle"));
var _http = _interopRequireDefault(require("http"));
var _https = _interopRequireDefault(require("https"));
var _axios = _interopRequireDefault(require("axios"));

/**
 * Handle HTTP requests with a uniform interface.
 */
class HttpClient {

  static MAX_REQUESTS_PER_SECOND = 50;

  // default request config
  static DEFAULT_REQUEST = {
    method: "GET",
    resolveWithFullResponse: false,
    rejectUnauthorized: true
  };

  // rate limit requests per host
  static PROMISE_THROTTLES = [];
  static TASK_QUEUES = [];
  static DEFAULT_TIMEOUT = 60000;
  static MAX_TIMEOUT = 2147483647; // max 32-bit signed number




  /**
   * <p>Make a HTTP request.<p>
   * 
   * @param {object} request - configures the request to make
   * @param {string} request.method - HTTP method ("GET", "PUT", "POST", "DELETE", etc)
   * @param {string} request.uri - uri to request
   * @param {string|Uint8Array|object} request.body - request body
   * @param {string} [request.username] - username to authenticate the request (optional)
   * @param {string} [request.password] - password to authenticate the request (optional)
   * @param {object} [request.headers] - headers to add to the request (optional)
   * @param {boolean} [request.resolveWithFullResponse] - return full response if true, else body only (default false)
   * @param {boolean} [request.rejectUnauthorized] - whether or not to reject self-signed certificates (default true)
   * @param {number} request.timeout - maximum time allowed in milliseconds
   * @param {number} request.proxyToWorker - proxy request to worker thread
   * @return {object} response - the response object
   * @return {string|Uint8Array|object} response.body - the response body
   * @return {number} response.statusCode - the response code
   * @return {String} response.statusText - the response message
   * @return {object} response.headers - the response headers
   */
  static async request(request) {
    // proxy to worker if configured
    if (request.proxyToWorker) {
      try {
        return await _LibraryUtils.default.invokeWorker(undefined, "httpRequest", request);
      } catch (err) {
        if (err.message.length > 0 && err.message.charAt(0) === "{") {
          let parsed = JSON.parse(err.message);
          err.message = parsed.statusMessage;
          err.statusCode = parsed.statusCode;
        }
        throw err;
      }
    }

    // assign defaults
    request = Object.assign({}, HttpClient.DEFAULT_REQUEST, request);

    // validate request
    try {request.host = new URL(request.uri).host;} // hostname:port
    catch (err) {throw new Error("Invalid request URL: " + request.uri);}
    if (request.body && !(typeof request.body === "string" || typeof request.body === "object")) {
      throw new Error("Request body type is not string or object");
    }

    // initialize one task queue per host
    if (!HttpClient.TASK_QUEUES[request.host]) HttpClient.TASK_QUEUES[request.host] = new _ThreadPool.default(1);

    // initialize one promise throttle per host
    if (!HttpClient.PROMISE_THROTTLES[request.host]) {
      HttpClient.PROMISE_THROTTLES[request.host] = new _promiseThrottle.default({
        requestsPerSecond: HttpClient.MAX_REQUESTS_PER_SECOND, // TODO: HttpClient should not depend on MoneroUtils for configuration
        promiseImplementation: Promise
      });
    }

    // request using fetch or xhr with timeout
    let timeout = request.timeout === undefined ? HttpClient.DEFAULT_TIMEOUT : request.timeout === 0 ? HttpClient.MAX_TIMEOUT : request.timeout;
    let requestPromise = HttpClient.requestAxios(request);
    return _GenUtils.default.executeWithTimeout(requestPromise, timeout);
  }

  // ----------------------------- PRIVATE HELPERS ----------------------------


  /**
   * Get a singleton instance of an HTTP client to share.
   *
   * @return {http.Agent} a shared agent for network requests among library instances
   */
  static getHttpAgent() {
    if (!HttpClient.HTTP_AGENT) HttpClient.HTTP_AGENT = new _http.default.Agent({
      keepAlive: true,
      family: 4 // use IPv4
    });
    return HttpClient.HTTP_AGENT;
  }

  /**
   * Get a singleton instance of an HTTPS client to share.
   *
   * @return {https.Agent} a shared agent for network requests among library instances
   */
  static getHttpsAgent() {
    if (!HttpClient.HTTPS_AGENT) HttpClient.HTTPS_AGENT = new _https.default.Agent({
      keepAlive: true,
      family: 4 // use IPv4
    });
    return HttpClient.HTTPS_AGENT;
  }

  static async requestAxios(req) {
    if (req.headers) throw new Error("Custom headers not implemented in XHR request"); // TODO

    // collect params from request which change on await
    const method = req.method;
    const uri = req.uri;
    const host = req.host;
    const username = req.username;
    const password = req.password;
    const body = req.body;
    const isBinary = body instanceof Uint8Array;

    // queue and throttle requests to execute in serial and rate limited per host
    const resp = await HttpClient.TASK_QUEUES[host].submit(async function () {
      return HttpClient.PROMISE_THROTTLES[host].add(function () {
        return new Promise(function (resolve, reject) {
          HttpClient.axiosDigestAuthRequest(method, uri, username, password, body).then(function (resp) {
            resolve(resp);
          }).catch(function (error) {
            if (error.response?.status) resolve(error.response);
            reject(new Error("Request failed without response: " + method + " " + uri + " due to underlying error:\n" + error.message + "\n" + error.stack));
          });
        });

      }.bind(this));
    });

    // normalize response
    let normalizedResponse = {};
    normalizedResponse.statusCode = resp.status;
    normalizedResponse.statusText = resp.statusText;
    normalizedResponse.headers = { ...resp.headers };
    normalizedResponse.body = isBinary ? new Uint8Array(resp.data) : resp.data;
    if (normalizedResponse.body instanceof ArrayBuffer) normalizedResponse.body = new Uint8Array(normalizedResponse.body); // handle empty binary request
    return normalizedResponse;
  }

  static axiosDigestAuthRequest = async function (method, url, username, password, body) {
    if (typeof CryptoJS === 'undefined' && typeof require === 'function') {
      var CryptoJS = require('crypto-js');
    }

    const generateCnonce = function () {
      const characters = 'abcdef0123456789';
      let token = '';
      for (let i = 0; i < 16; i++) {
        const randNum = Math.round(Math.random() * characters.length);
        token += characters.slice(randNum, randNum + 1);
      }
      return token;
    };

    let count = 0;
    return _axios.default.request({
      url: url,
      method: method,
      timeout: this.timeout,
      headers: {
        'Content-Type': 'application/json'
      },
      responseType: body instanceof Uint8Array ? 'arraybuffer' : undefined,
      httpAgent: url.startsWith("https") ? undefined : HttpClient.getHttpAgent(),
      httpsAgent: url.startsWith("https") ? HttpClient.getHttpsAgent() : undefined,
      data: body,
      transformResponse: (res) => res,
      adapter: _GenUtils.default.isDeno() ? ['fetch'] : ['http', 'xhr', 'fetch']
    }).catch(async (err) => {
      if (err.response?.status === 401) {
        let authHeader = err.response.headers['www-authenticate'].replace(/,\sDigest.*/, "");
        if (!authHeader) {
          throw err;
        }

        // Digest qop="auth",algorithm=MD5,realm="monero-rpc",nonce="hBZ2rZIxElv4lqCRrUylXA==",stale=false
        const authHeaderMap = authHeader.replace("Digest ", "").replaceAll('"', "").split(",").reduce((prev, curr) => ({ ...prev, [curr.split("=")[0]]: curr.split("=").slice(1).join('=') }), {});

        ++count;

        const cnonce = generateCnonce();
        const HA1 = CryptoJS.MD5(username + ':' + authHeaderMap.realm + ':' + password).toString();
        const HA2 = CryptoJS.MD5(method + ':' + url).toString();

        const response = CryptoJS.MD5(HA1 + ':' +
        authHeaderMap.nonce + ':' +
        ('00000000' + count).slice(-8) + ':' +
        cnonce + ':' +
        authHeaderMap.qop + ':' +
        HA2).toString();
        const digestAuthHeader = 'Digest' + ' ' +
        'username="' + username + '", ' +
        'realm="' + authHeaderMap.realm + '", ' +
        'nonce="' + authHeaderMap.nonce + '", ' +
        'uri="' + url + '", ' +
        'response="' + response + '", ' +
        'opaque="' + (authHeaderMap.opaque ?? null) + '", ' +
        'qop=' + authHeaderMap.qop + ', ' +
        'nc=' + ('00000000' + count).slice(-8) + ', ' +
        'cnonce="' + cnonce + '"';

        const finalResponse = await _axios.default.request({
          url: url,
          method: method,
          timeout: this.timeout,
          headers: {
            'Authorization': digestAuthHeader,
            'Content-Type': 'application/json'
          },
          responseType: body instanceof Uint8Array ? 'arraybuffer' : undefined,
          httpAgent: url.startsWith("https") ? undefined : HttpClient.getHttpAgent(),
          httpsAgent: url.startsWith("https") ? HttpClient.getHttpsAgent() : undefined,
          data: body,
          transformResponse: (res) => res,
          adapter: _GenUtils.default.isDeno() ? ['fetch'] : ['http', 'xhr', 'fetch']
        });

        return finalResponse;
      }
      throw err;
    }).catch((err) => {
      throw err;
    });
  };
}exports.default = HttpClient;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfR2VuVXRpbHMiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9MaWJyYXJ5VXRpbHMiLCJfVGhyZWFkUG9vbCIsIl9wcm9taXNlVGhyb3R0bGUiLCJfaHR0cCIsIl9odHRwcyIsIl9heGlvcyIsIkh0dHBDbGllbnQiLCJNQVhfUkVRVUVTVFNfUEVSX1NFQ09ORCIsIkRFRkFVTFRfUkVRVUVTVCIsIm1ldGhvZCIsInJlc29sdmVXaXRoRnVsbFJlc3BvbnNlIiwicmVqZWN0VW5hdXRob3JpemVkIiwiUFJPTUlTRV9USFJPVFRMRVMiLCJUQVNLX1FVRVVFUyIsIkRFRkFVTFRfVElNRU9VVCIsIk1BWF9USU1FT1VUIiwicmVxdWVzdCIsInByb3h5VG9Xb3JrZXIiLCJMaWJyYXJ5VXRpbHMiLCJpbnZva2VXb3JrZXIiLCJ1bmRlZmluZWQiLCJlcnIiLCJtZXNzYWdlIiwibGVuZ3RoIiwiY2hhckF0IiwicGFyc2VkIiwiSlNPTiIsInBhcnNlIiwic3RhdHVzTWVzc2FnZSIsInN0YXR1c0NvZGUiLCJPYmplY3QiLCJhc3NpZ24iLCJob3N0IiwiVVJMIiwidXJpIiwiRXJyb3IiLCJib2R5IiwiVGhyZWFkUG9vbCIsIlByb21pc2VUaHJvdHRsZSIsInJlcXVlc3RzUGVyU2Vjb25kIiwicHJvbWlzZUltcGxlbWVudGF0aW9uIiwiUHJvbWlzZSIsInRpbWVvdXQiLCJyZXF1ZXN0UHJvbWlzZSIsInJlcXVlc3RBeGlvcyIsIkdlblV0aWxzIiwiZXhlY3V0ZVdpdGhUaW1lb3V0IiwiZ2V0SHR0cEFnZW50IiwiSFRUUF9BR0VOVCIsImh0dHAiLCJBZ2VudCIsImtlZXBBbGl2ZSIsImZhbWlseSIsImdldEh0dHBzQWdlbnQiLCJIVFRQU19BR0VOVCIsImh0dHBzIiwicmVxIiwiaGVhZGVycyIsInVzZXJuYW1lIiwicGFzc3dvcmQiLCJpc0JpbmFyeSIsIlVpbnQ4QXJyYXkiLCJyZXNwIiwic3VibWl0IiwiYWRkIiwicmVzb2x2ZSIsInJlamVjdCIsImF4aW9zRGlnZXN0QXV0aFJlcXVlc3QiLCJ0aGVuIiwiY2F0Y2giLCJlcnJvciIsInJlc3BvbnNlIiwic3RhdHVzIiwic3RhY2siLCJiaW5kIiwibm9ybWFsaXplZFJlc3BvbnNlIiwic3RhdHVzVGV4dCIsImRhdGEiLCJBcnJheUJ1ZmZlciIsInVybCIsIkNyeXB0b0pTIiwiZ2VuZXJhdGVDbm9uY2UiLCJjaGFyYWN0ZXJzIiwidG9rZW4iLCJpIiwicmFuZE51bSIsIk1hdGgiLCJyb3VuZCIsInJhbmRvbSIsInNsaWNlIiwiY291bnQiLCJheGlvcyIsInJlc3BvbnNlVHlwZSIsImh0dHBBZ2VudCIsInN0YXJ0c1dpdGgiLCJodHRwc0FnZW50IiwidHJhbnNmb3JtUmVzcG9uc2UiLCJyZXMiLCJhZGFwdGVyIiwiaXNEZW5vIiwiYXV0aEhlYWRlciIsInJlcGxhY2UiLCJhdXRoSGVhZGVyTWFwIiwicmVwbGFjZUFsbCIsInNwbGl0IiwicmVkdWNlIiwicHJldiIsImN1cnIiLCJqb2luIiwiY25vbmNlIiwiSEExIiwiTUQ1IiwicmVhbG0iLCJ0b1N0cmluZyIsIkhBMiIsIm5vbmNlIiwicW9wIiwiZGlnZXN0QXV0aEhlYWRlciIsIm9wYXF1ZSIsImZpbmFsUmVzcG9uc2UiLCJleHBvcnRzIiwiZGVmYXVsdCJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9tYWluL3RzL2NvbW1vbi9IdHRwQ2xpZW50LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBHZW5VdGlscyBmcm9tIFwiLi9HZW5VdGlsc1wiO1xuaW1wb3J0IExpYnJhcnlVdGlscyBmcm9tIFwiLi9MaWJyYXJ5VXRpbHNcIjtcbmltcG9ydCBUaHJlYWRQb29sIGZyb20gXCIuL1RocmVhZFBvb2xcIjtcbmltcG9ydCBQcm9taXNlVGhyb3R0bGUgZnJvbSBcInByb21pc2UtdGhyb3R0bGVcIjtcbmltcG9ydCBodHRwIGZyb20gXCJodHRwXCI7XG5pbXBvcnQgaHR0cHMgZnJvbSBcImh0dHBzXCI7XG5pbXBvcnQgYXhpb3MsIHsgQXhpb3NFcnJvciB9IGZyb20gXCJheGlvc1wiO1xuXG4vKipcbiAqIEhhbmRsZSBIVFRQIHJlcXVlc3RzIHdpdGggYSB1bmlmb3JtIGludGVyZmFjZS5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSHR0cENsaWVudCB7XG5cbiAgc3RhdGljIE1BWF9SRVFVRVNUU19QRVJfU0VDT05EID0gNTA7XG5cbiAgLy8gZGVmYXVsdCByZXF1ZXN0IGNvbmZpZ1xuICBwcm90ZWN0ZWQgc3RhdGljIERFRkFVTFRfUkVRVUVTVCA9IHtcbiAgICBtZXRob2Q6IFwiR0VUXCIsXG4gICAgcmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2U6IGZhbHNlLFxuICAgIHJlamVjdFVuYXV0aG9yaXplZDogdHJ1ZVxuICB9XG5cbiAgLy8gcmF0ZSBsaW1pdCByZXF1ZXN0cyBwZXIgaG9zdFxuICBwcm90ZWN0ZWQgc3RhdGljIFBST01JU0VfVEhST1RUTEVTID0gW107XG4gIHByb3RlY3RlZCBzdGF0aWMgVEFTS19RVUVVRVMgPSBbXTtcbiAgcHJvdGVjdGVkIHN0YXRpYyBERUZBVUxUX1RJTUVPVVQgPSA2MDAwMDtcbiAgc3RhdGljIE1BWF9USU1FT1VUID0gMjE0NzQ4MzY0NzsgLy8gbWF4IDMyLWJpdCBzaWduZWQgbnVtYmVyXG5cbiAgcHJvdGVjdGVkIHN0YXRpYyBIVFRQX0FHRU5UOiBhbnk7XG4gIHByb3RlY3RlZCBzdGF0aWMgSFRUUFNfQUdFTlQ6IGFueTtcblxuICAvKipcbiAgICogPHA+TWFrZSBhIEhUVFAgcmVxdWVzdC48cD5cbiAgICogXG4gICAqIEBwYXJhbSB7b2JqZWN0fSByZXF1ZXN0IC0gY29uZmlndXJlcyB0aGUgcmVxdWVzdCB0byBtYWtlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSByZXF1ZXN0Lm1ldGhvZCAtIEhUVFAgbWV0aG9kIChcIkdFVFwiLCBcIlBVVFwiLCBcIlBPU1RcIiwgXCJERUxFVEVcIiwgZXRjKVxuICAgKiBAcGFyYW0ge3N0cmluZ30gcmVxdWVzdC51cmkgLSB1cmkgdG8gcmVxdWVzdFxuICAgKiBAcGFyYW0ge3N0cmluZ3xVaW50OEFycmF5fG9iamVjdH0gcmVxdWVzdC5ib2R5IC0gcmVxdWVzdCBib2R5XG4gICAqIEBwYXJhbSB7c3RyaW5nfSBbcmVxdWVzdC51c2VybmFtZV0gLSB1c2VybmFtZSB0byBhdXRoZW50aWNhdGUgdGhlIHJlcXVlc3QgKG9wdGlvbmFsKVxuICAgKiBAcGFyYW0ge3N0cmluZ30gW3JlcXVlc3QucGFzc3dvcmRdIC0gcGFzc3dvcmQgdG8gYXV0aGVudGljYXRlIHRoZSByZXF1ZXN0IChvcHRpb25hbClcbiAgICogQHBhcmFtIHtvYmplY3R9IFtyZXF1ZXN0LmhlYWRlcnNdIC0gaGVhZGVycyB0byBhZGQgdG8gdGhlIHJlcXVlc3QgKG9wdGlvbmFsKVxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtyZXF1ZXN0LnJlc29sdmVXaXRoRnVsbFJlc3BvbnNlXSAtIHJldHVybiBmdWxsIHJlc3BvbnNlIGlmIHRydWUsIGVsc2UgYm9keSBvbmx5IChkZWZhdWx0IGZhbHNlKVxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtyZXF1ZXN0LnJlamVjdFVuYXV0aG9yaXplZF0gLSB3aGV0aGVyIG9yIG5vdCB0byByZWplY3Qgc2VsZi1zaWduZWQgY2VydGlmaWNhdGVzIChkZWZhdWx0IHRydWUpXG4gICAqIEBwYXJhbSB7bnVtYmVyfSByZXF1ZXN0LnRpbWVvdXQgLSBtYXhpbXVtIHRpbWUgYWxsb3dlZCBpbiBtaWxsaXNlY29uZHNcbiAgICogQHBhcmFtIHtudW1iZXJ9IHJlcXVlc3QucHJveHlUb1dvcmtlciAtIHByb3h5IHJlcXVlc3QgdG8gd29ya2VyIHRocmVhZFxuICAgKiBAcmV0dXJuIHtvYmplY3R9IHJlc3BvbnNlIC0gdGhlIHJlc3BvbnNlIG9iamVjdFxuICAgKiBAcmV0dXJuIHtzdHJpbmd8VWludDhBcnJheXxvYmplY3R9IHJlc3BvbnNlLmJvZHkgLSB0aGUgcmVzcG9uc2UgYm9keVxuICAgKiBAcmV0dXJuIHtudW1iZXJ9IHJlc3BvbnNlLnN0YXR1c0NvZGUgLSB0aGUgcmVzcG9uc2UgY29kZVxuICAgKiBAcmV0dXJuIHtTdHJpbmd9IHJlc3BvbnNlLnN0YXR1c1RleHQgLSB0aGUgcmVzcG9uc2UgbWVzc2FnZVxuICAgKiBAcmV0dXJuIHtvYmplY3R9IHJlc3BvbnNlLmhlYWRlcnMgLSB0aGUgcmVzcG9uc2UgaGVhZGVyc1xuICAgKi9cbiAgc3RhdGljIGFzeW5jIHJlcXVlc3QocmVxdWVzdCkge1xuICAgIC8vIHByb3h5IHRvIHdvcmtlciBpZiBjb25maWd1cmVkXG4gICAgaWYgKHJlcXVlc3QucHJveHlUb1dvcmtlcikge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IExpYnJhcnlVdGlscy5pbnZva2VXb3JrZXIodW5kZWZpbmVkLCBcImh0dHBSZXF1ZXN0XCIsIHJlcXVlc3QpO1xuICAgICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICAgICAgaWYgKGVyci5tZXNzYWdlLmxlbmd0aCA+IDAgJiYgZXJyLm1lc3NhZ2UuY2hhckF0KDApID09PSBcIntcIikge1xuICAgICAgICAgIGxldCBwYXJzZWQgPSBKU09OLnBhcnNlKGVyci5tZXNzYWdlKTtcbiAgICAgICAgICBlcnIubWVzc2FnZSA9IHBhcnNlZC5zdGF0dXNNZXNzYWdlO1xuICAgICAgICAgIGVyci5zdGF0dXNDb2RlID0gcGFyc2VkLnN0YXR1c0NvZGU7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGFzc2lnbiBkZWZhdWx0c1xuICAgIHJlcXVlc3QgPSBPYmplY3QuYXNzaWduKHt9LCBIdHRwQ2xpZW50LkRFRkFVTFRfUkVRVUVTVCwgcmVxdWVzdCk7XG5cbiAgICAvLyB2YWxpZGF0ZSByZXF1ZXN0XG4gICAgdHJ5IHsgcmVxdWVzdC5ob3N0ID0gbmV3IFVSTChyZXF1ZXN0LnVyaSkuaG9zdDsgfSAvLyBob3N0bmFtZTpwb3J0XG4gICAgY2F0Y2ggKGVycikgeyB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIHJlcXVlc3QgVVJMOiBcIiArIHJlcXVlc3QudXJpKTsgfVxuICAgIGlmIChyZXF1ZXN0LmJvZHkgJiYgISh0eXBlb2YgcmVxdWVzdC5ib2R5ID09PSBcInN0cmluZ1wiIHx8IHR5cGVvZiByZXF1ZXN0LmJvZHkgPT09IFwib2JqZWN0XCIpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJSZXF1ZXN0IGJvZHkgdHlwZSBpcyBub3Qgc3RyaW5nIG9yIG9iamVjdFwiKTtcbiAgICB9XG5cbiAgICAvLyBpbml0aWFsaXplIG9uZSB0YXNrIHF1ZXVlIHBlciBob3N0XG4gICAgaWYgKCFIdHRwQ2xpZW50LlRBU0tfUVVFVUVTW3JlcXVlc3QuaG9zdF0pIEh0dHBDbGllbnQuVEFTS19RVUVVRVNbcmVxdWVzdC5ob3N0XSA9IG5ldyBUaHJlYWRQb29sKDEpO1xuXG4gICAgLy8gaW5pdGlhbGl6ZSBvbmUgcHJvbWlzZSB0aHJvdHRsZSBwZXIgaG9zdFxuICAgIGlmICghSHR0cENsaWVudC5QUk9NSVNFX1RIUk9UVExFU1tyZXF1ZXN0Lmhvc3RdKSB7XG4gICAgICBIdHRwQ2xpZW50LlBST01JU0VfVEhST1RUTEVTW3JlcXVlc3QuaG9zdF0gPSBuZXcgUHJvbWlzZVRocm90dGxlKHtcbiAgICAgICAgcmVxdWVzdHNQZXJTZWNvbmQ6IEh0dHBDbGllbnQuTUFYX1JFUVVFU1RTX1BFUl9TRUNPTkQsIC8vIFRPRE86IEh0dHBDbGllbnQgc2hvdWxkIG5vdCBkZXBlbmQgb24gTW9uZXJvVXRpbHMgZm9yIGNvbmZpZ3VyYXRpb25cbiAgICAgICAgcHJvbWlzZUltcGxlbWVudGF0aW9uOiBQcm9taXNlXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyByZXF1ZXN0IHVzaW5nIGZldGNoIG9yIHhociB3aXRoIHRpbWVvdXRcbiAgICBsZXQgdGltZW91dCA9IHJlcXVlc3QudGltZW91dCA9PT0gdW5kZWZpbmVkID8gSHR0cENsaWVudC5ERUZBVUxUX1RJTUVPVVQgOiByZXF1ZXN0LnRpbWVvdXQgPT09IDAgPyBIdHRwQ2xpZW50Lk1BWF9USU1FT1VUIDogcmVxdWVzdC50aW1lb3V0O1xuICAgIGxldCByZXF1ZXN0UHJvbWlzZSA9IEh0dHBDbGllbnQucmVxdWVzdEF4aW9zKHJlcXVlc3QpO1xuICAgIHJldHVybiBHZW5VdGlscy5leGVjdXRlV2l0aFRpbWVvdXQocmVxdWVzdFByb21pc2UsIHRpbWVvdXQpO1xuICB9XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gUFJJVkFURSBIRUxQRVJTIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuXG4gIC8qKlxuICAgKiBHZXQgYSBzaW5nbGV0b24gaW5zdGFuY2Ugb2YgYW4gSFRUUCBjbGllbnQgdG8gc2hhcmUuXG4gICAqXG4gICAqIEByZXR1cm4ge2h0dHAuQWdlbnR9IGEgc2hhcmVkIGFnZW50IGZvciBuZXR3b3JrIHJlcXVlc3RzIGFtb25nIGxpYnJhcnkgaW5zdGFuY2VzXG4gICAqL1xuICBwcm90ZWN0ZWQgc3RhdGljIGdldEh0dHBBZ2VudCgpIHtcbiAgICBpZiAoIUh0dHBDbGllbnQuSFRUUF9BR0VOVCkgSHR0cENsaWVudC5IVFRQX0FHRU5UID0gbmV3IGh0dHAuQWdlbnQoe1xuICAgICAga2VlcEFsaXZlOiB0cnVlLFxuICAgICAgZmFtaWx5OiA0IC8vIHVzZSBJUHY0XG4gICAgfSk7XG4gICAgcmV0dXJuIEh0dHBDbGllbnQuSFRUUF9BR0VOVDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYSBzaW5nbGV0b24gaW5zdGFuY2Ugb2YgYW4gSFRUUFMgY2xpZW50IHRvIHNoYXJlLlxuICAgKlxuICAgKiBAcmV0dXJuIHtodHRwcy5BZ2VudH0gYSBzaGFyZWQgYWdlbnQgZm9yIG5ldHdvcmsgcmVxdWVzdHMgYW1vbmcgbGlicmFyeSBpbnN0YW5jZXNcbiAgICovXG4gIHByb3RlY3RlZCBzdGF0aWMgZ2V0SHR0cHNBZ2VudCgpIHtcbiAgICBpZiAoIUh0dHBDbGllbnQuSFRUUFNfQUdFTlQpIEh0dHBDbGllbnQuSFRUUFNfQUdFTlQgPSBuZXcgaHR0cHMuQWdlbnQoe1xuICAgICAga2VlcEFsaXZlOiB0cnVlLFxuICAgICAgZmFtaWx5OiA0IC8vIHVzZSBJUHY0XG4gICAgfSk7XG4gICAgcmV0dXJuIEh0dHBDbGllbnQuSFRUUFNfQUdFTlQ7XG4gIH1cblxuICBwcm90ZWN0ZWQgc3RhdGljIGFzeW5jIHJlcXVlc3RBeGlvcyhyZXEpIHtcbiAgICBpZiAocmVxLmhlYWRlcnMpIHRocm93IG5ldyBFcnJvcihcIkN1c3RvbSBoZWFkZXJzIG5vdCBpbXBsZW1lbnRlZCBpbiBYSFIgcmVxdWVzdFwiKTsgIC8vIFRPRE9cblxuICAgIC8vIGNvbGxlY3QgcGFyYW1zIGZyb20gcmVxdWVzdCB3aGljaCBjaGFuZ2Ugb24gYXdhaXRcbiAgICBjb25zdCBtZXRob2QgPSByZXEubWV0aG9kO1xuICAgIGNvbnN0IHVyaSA9IHJlcS51cmk7XG4gICAgY29uc3QgaG9zdCA9IHJlcS5ob3N0O1xuICAgIGNvbnN0IHVzZXJuYW1lID0gcmVxLnVzZXJuYW1lO1xuICAgIGNvbnN0IHBhc3N3b3JkID0gcmVxLnBhc3N3b3JkO1xuICAgIGNvbnN0IGJvZHkgPSByZXEuYm9keTtcbiAgICBjb25zdCBpc0JpbmFyeSA9IGJvZHkgaW5zdGFuY2VvZiBVaW50OEFycmF5O1xuXG4gICAgLy8gcXVldWUgYW5kIHRocm90dGxlIHJlcXVlc3RzIHRvIGV4ZWN1dGUgaW4gc2VyaWFsIGFuZCByYXRlIGxpbWl0ZWQgcGVyIGhvc3RcbiAgICBjb25zdCByZXNwID0gYXdhaXQgSHR0cENsaWVudC5UQVNLX1FVRVVFU1tob3N0XS5zdWJtaXQoYXN5bmMgZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gSHR0cENsaWVudC5QUk9NSVNFX1RIUk9UVExFU1tob3N0XS5hZGQoZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICBIdHRwQ2xpZW50LmF4aW9zRGlnZXN0QXV0aFJlcXVlc3QobWV0aG9kLCB1cmksIHVzZXJuYW1lLCBwYXNzd29yZCwgYm9keSkudGhlbihmdW5jdGlvbihyZXNwKSB7XG4gICAgICAgICAgICByZXNvbHZlKHJlc3ApO1xuICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycm9yOiBBeGlvc0Vycm9yKSB7XG4gICAgICAgICAgICBpZiAoZXJyb3IucmVzcG9uc2U/LnN0YXR1cykgcmVzb2x2ZShlcnJvci5yZXNwb25zZSk7XG4gICAgICAgICAgICByZWplY3QobmV3IEVycm9yKFwiUmVxdWVzdCBmYWlsZWQgd2l0aG91dCByZXNwb25zZTogXCIgKyBtZXRob2QgKyBcIiBcIiArIHVyaSArIFwiIGR1ZSB0byB1bmRlcmx5aW5nIGVycm9yOlxcblwiICsgZXJyb3IubWVzc2FnZSArIFwiXFxuXCIgKyBlcnJvci5zdGFjaykpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgfS5iaW5kKHRoaXMpKTtcbiAgICB9KTtcblxuICAgIC8vIG5vcm1hbGl6ZSByZXNwb25zZVxuICAgIGxldCBub3JtYWxpemVkUmVzcG9uc2U6IGFueSA9IHt9O1xuICAgIG5vcm1hbGl6ZWRSZXNwb25zZS5zdGF0dXNDb2RlID0gcmVzcC5zdGF0dXM7XG4gICAgbm9ybWFsaXplZFJlc3BvbnNlLnN0YXR1c1RleHQgPSByZXNwLnN0YXR1c1RleHQ7XG4gICAgbm9ybWFsaXplZFJlc3BvbnNlLmhlYWRlcnMgPSB7Li4ucmVzcC5oZWFkZXJzfTtcbiAgICBub3JtYWxpemVkUmVzcG9uc2UuYm9keSA9IGlzQmluYXJ5ID8gbmV3IFVpbnQ4QXJyYXkocmVzcC5kYXRhKSA6IHJlc3AuZGF0YTtcbiAgICBpZiAobm9ybWFsaXplZFJlc3BvbnNlLmJvZHkgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgbm9ybWFsaXplZFJlc3BvbnNlLmJvZHkgPSBuZXcgVWludDhBcnJheShub3JtYWxpemVkUmVzcG9uc2UuYm9keSk7ICAvLyBoYW5kbGUgZW1wdHkgYmluYXJ5IHJlcXVlc3RcbiAgICByZXR1cm4gbm9ybWFsaXplZFJlc3BvbnNlO1xuICB9XG5cbiAgcHJvdGVjdGVkIHN0YXRpYyBheGlvc0RpZ2VzdEF1dGhSZXF1ZXN0ID0gYXN5bmMgZnVuY3Rpb24obWV0aG9kLCB1cmwsIHVzZXJuYW1lLCBwYXNzd29yZCwgYm9keSkge1xuICAgIGlmICh0eXBlb2YgQ3J5cHRvSlMgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiByZXF1aXJlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICB2YXIgQ3J5cHRvSlMgPSByZXF1aXJlKCdjcnlwdG8tanMnKTtcbiAgICB9XG5cbiAgICBjb25zdCBnZW5lcmF0ZUNub25jZSA9IGZ1bmN0aW9uKCk6IHN0cmluZyB7XG4gICAgICBjb25zdCBjaGFyYWN0ZXJzID0gJ2FiY2RlZjAxMjM0NTY3ODknO1xuICAgICAgbGV0IHRva2VuID0gJyc7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDE2OyBpKyspIHtcbiAgICAgICAgY29uc3QgcmFuZE51bSA9IE1hdGgucm91bmQoTWF0aC5yYW5kb20oKSAqIGNoYXJhY3RlcnMubGVuZ3RoKTtcbiAgICAgICAgdG9rZW4gKz0gY2hhcmFjdGVycy5zbGljZShyYW5kTnVtLCByYW5kTnVtKzEpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRva2VuO1xuICAgIH1cblxuICAgIGxldCBjb3VudCA9IDA7XG4gICAgcmV0dXJuIGF4aW9zLnJlcXVlc3Qoe1xuICAgICAgdXJsOiB1cmwsXG4gICAgICBtZXRob2Q6IG1ldGhvZCxcbiAgICAgIHRpbWVvdXQ6IHRoaXMudGltZW91dCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ1xuICAgICAgfSxcbiAgICAgIHJlc3BvbnNlVHlwZTogYm9keSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkgPyAnYXJyYXlidWZmZXInIDogdW5kZWZpbmVkLFxuICAgICAgaHR0cEFnZW50OiB1cmwuc3RhcnRzV2l0aChcImh0dHBzXCIpID8gdW5kZWZpbmVkIDogSHR0cENsaWVudC5nZXRIdHRwQWdlbnQoKSxcbiAgICAgIGh0dHBzQWdlbnQ6IHVybC5zdGFydHNXaXRoKFwiaHR0cHNcIikgPyBIdHRwQ2xpZW50LmdldEh0dHBzQWdlbnQoKSA6IHVuZGVmaW5lZCxcbiAgICAgIGRhdGE6IGJvZHksXG4gICAgICB0cmFuc2Zvcm1SZXNwb25zZTogcmVzID0+IHJlcyxcbiAgICAgIGFkYXB0ZXI6IEdlblV0aWxzLmlzRGVubygpID8gWydmZXRjaCddIDogWydodHRwJywgJ3hocicsICdmZXRjaCddXG4gICAgfSkuY2F0Y2goYXN5bmMgKGVycikgPT4ge1xuICAgICAgaWYgKGVyci5yZXNwb25zZT8uc3RhdHVzID09PSA0MDEpIHtcbiAgICAgICAgbGV0IGF1dGhIZWFkZXIgPSBlcnIucmVzcG9uc2UuaGVhZGVyc1snd3d3LWF1dGhlbnRpY2F0ZSddLnJlcGxhY2UoLyxcXHNEaWdlc3QuKi8sIFwiXCIpO1xuICAgICAgICBpZiAoIWF1dGhIZWFkZXIpIHtcbiAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBEaWdlc3QgcW9wPVwiYXV0aFwiLGFsZ29yaXRobT1NRDUscmVhbG09XCJtb25lcm8tcnBjXCIsbm9uY2U9XCJoQloyclpJeEVsdjRscUNSclV5bFhBPT1cIixzdGFsZT1mYWxzZVxuICAgICAgICBjb25zdCBhdXRoSGVhZGVyTWFwID0gYXV0aEhlYWRlci5yZXBsYWNlKFwiRGlnZXN0IFwiLCBcIlwiKS5yZXBsYWNlQWxsKCdcIicsIFwiXCIpLnNwbGl0KFwiLFwiKS5yZWR1Y2UoKHByZXYsIGN1cnIpID0+ICh7Li4ucHJldiwgW2N1cnIuc3BsaXQoXCI9XCIpWzBdXTogY3Vyci5zcGxpdChcIj1cIikuc2xpY2UoMSkuam9pbignPScpfSksIHt9KVxuXG4gICAgICAgICsrY291bnQ7XG5cbiAgICAgICAgY29uc3QgY25vbmNlID0gZ2VuZXJhdGVDbm9uY2UoKTtcbiAgICAgICAgY29uc3QgSEExID0gQ3J5cHRvSlMuTUQ1KHVzZXJuYW1lKyc6JythdXRoSGVhZGVyTWFwLnJlYWxtKyc6JytwYXNzd29yZCkudG9TdHJpbmcoKTtcbiAgICAgICAgY29uc3QgSEEyID0gQ3J5cHRvSlMuTUQ1KG1ldGhvZCsnOicrdXJsKS50b1N0cmluZygpO1xuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gQ3J5cHRvSlMuTUQ1KEhBMSsnOicrXG4gICAgICAgICAgYXV0aEhlYWRlck1hcC5ub25jZSsnOicrXG4gICAgICAgICAgKCcwMDAwMDAwMCcgKyBjb3VudCkuc2xpY2UoLTgpKyc6JytcbiAgICAgICAgICBjbm9uY2UrJzonK1xuICAgICAgICAgIGF1dGhIZWFkZXJNYXAucW9wKyc6JytcbiAgICAgICAgICBIQTIpLnRvU3RyaW5nKCk7XG4gICAgICAgIGNvbnN0IGRpZ2VzdEF1dGhIZWFkZXIgPSAnRGlnZXN0JysnICcrXG4gICAgICAgICAgJ3VzZXJuYW1lPVwiJyt1c2VybmFtZSsnXCIsICcrXG4gICAgICAgICAgJ3JlYWxtPVwiJythdXRoSGVhZGVyTWFwLnJlYWxtKydcIiwgJytcbiAgICAgICAgICAnbm9uY2U9XCInK2F1dGhIZWFkZXJNYXAubm9uY2UrJ1wiLCAnK1xuICAgICAgICAgICd1cmk9XCInK3VybCsnXCIsICcrXG4gICAgICAgICAgJ3Jlc3BvbnNlPVwiJytyZXNwb25zZSsnXCIsICcrXG4gICAgICAgICAgJ29wYXF1ZT1cIicrKGF1dGhIZWFkZXJNYXAub3BhcXVlID8/IG51bGwpKydcIiwgJytcbiAgICAgICAgICAncW9wPScrYXV0aEhlYWRlck1hcC5xb3ArJywgJytcbiAgICAgICAgICAnbmM9JysoJzAwMDAwMDAwJyArIGNvdW50KS5zbGljZSgtOCkrJywgJytcbiAgICAgICAgICAnY25vbmNlPVwiJytjbm9uY2UrJ1wiJztcblxuICAgICAgICBjb25zdCBmaW5hbFJlc3BvbnNlID0gYXdhaXQgYXhpb3MucmVxdWVzdCh7XG4gICAgICAgICAgdXJsOiB1cmwsXG4gICAgICAgICAgbWV0aG9kOiBtZXRob2QsXG4gICAgICAgICAgdGltZW91dDogdGhpcy50aW1lb3V0LFxuICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogZGlnZXN0QXV0aEhlYWRlcixcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcbiAgICAgICAgICB9LFxuICAgICAgICAgIHJlc3BvbnNlVHlwZTogYm9keSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkgPyAnYXJyYXlidWZmZXInIDogdW5kZWZpbmVkLFxuICAgICAgICAgIGh0dHBBZ2VudDogdXJsLnN0YXJ0c1dpdGgoXCJodHRwc1wiKSA/IHVuZGVmaW5lZCA6IEh0dHBDbGllbnQuZ2V0SHR0cEFnZW50KCksXG4gICAgICAgICAgaHR0cHNBZ2VudDogdXJsLnN0YXJ0c1dpdGgoXCJodHRwc1wiKSA/IEh0dHBDbGllbnQuZ2V0SHR0cHNBZ2VudCgpIDogdW5kZWZpbmVkLFxuICAgICAgICAgIGRhdGE6IGJvZHksXG4gICAgICAgICAgdHJhbnNmb3JtUmVzcG9uc2U6IHJlcyA9PiByZXMsXG4gICAgICAgICAgYWRhcHRlcjogR2VuVXRpbHMuaXNEZW5vKCkgPyBbJ2ZldGNoJ10gOiBbJ2h0dHAnLCAneGhyJywgJ2ZldGNoJ11cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGZpbmFsUmVzcG9uc2U7XG4gICAgICB9XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgIHRocm93IGVycjtcbiAgICB9KTtcbiAgfVxufVxuIl0sIm1hcHBpbmdzIjoieUxBQUEsSUFBQUEsU0FBQSxHQUFBQyxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUMsYUFBQSxHQUFBRixzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUUsV0FBQSxHQUFBSCxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUcsZ0JBQUEsR0FBQUosc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFJLEtBQUEsR0FBQUwsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFLLE1BQUEsR0FBQU4sc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFNLE1BQUEsR0FBQVAsc0JBQUEsQ0FBQUMsT0FBQTs7QUFFQTtBQUNBO0FBQ0E7QUFDZSxNQUFNTyxVQUFVLENBQUM7O0VBRTlCLE9BQU9DLHVCQUF1QixHQUFHLEVBQUU7O0VBRW5DO0VBQ0EsT0FBaUJDLGVBQWUsR0FBRztJQUNqQ0MsTUFBTSxFQUFFLEtBQUs7SUFDYkMsdUJBQXVCLEVBQUUsS0FBSztJQUM5QkMsa0JBQWtCLEVBQUU7RUFDdEIsQ0FBQzs7RUFFRDtFQUNBLE9BQWlCQyxpQkFBaUIsR0FBRyxFQUFFO0VBQ3ZDLE9BQWlCQyxXQUFXLEdBQUcsRUFBRTtFQUNqQyxPQUFpQkMsZUFBZSxHQUFHLEtBQUs7RUFDeEMsT0FBT0MsV0FBVyxHQUFHLFVBQVUsQ0FBQyxDQUFDOzs7OztFQUtqQztBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0VBQ0UsYUFBYUMsT0FBT0EsQ0FBQ0EsT0FBTyxFQUFFO0lBQzVCO0lBQ0EsSUFBSUEsT0FBTyxDQUFDQyxhQUFhLEVBQUU7TUFDekIsSUFBSTtRQUNGLE9BQU8sTUFBTUMscUJBQVksQ0FBQ0MsWUFBWSxDQUFDQyxTQUFTLEVBQUUsYUFBYSxFQUFFSixPQUFPLENBQUM7TUFDM0UsQ0FBQyxDQUFDLE9BQU9LLEdBQVEsRUFBRTtRQUNqQixJQUFJQSxHQUFHLENBQUNDLE9BQU8sQ0FBQ0MsTUFBTSxHQUFHLENBQUMsSUFBSUYsR0FBRyxDQUFDQyxPQUFPLENBQUNFLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLEVBQUU7VUFDM0QsSUFBSUMsTUFBTSxHQUFHQyxJQUFJLENBQUNDLEtBQUssQ0FBQ04sR0FBRyxDQUFDQyxPQUFPLENBQUM7VUFDcENELEdBQUcsQ0FBQ0MsT0FBTyxHQUFHRyxNQUFNLENBQUNHLGFBQWE7VUFDbENQLEdBQUcsQ0FBQ1EsVUFBVSxHQUFHSixNQUFNLENBQUNJLFVBQVU7UUFDcEM7UUFDQSxNQUFNUixHQUFHO01BQ1g7SUFDRjs7SUFFQTtJQUNBTCxPQUFPLEdBQUdjLE1BQU0sQ0FBQ0MsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFekIsVUFBVSxDQUFDRSxlQUFlLEVBQUVRLE9BQU8sQ0FBQzs7SUFFaEU7SUFDQSxJQUFJLENBQUVBLE9BQU8sQ0FBQ2dCLElBQUksR0FBRyxJQUFJQyxHQUFHLENBQUNqQixPQUFPLENBQUNrQixHQUFHLENBQUMsQ0FBQ0YsSUFBSSxDQUFFLENBQUMsQ0FBQztJQUNsRCxPQUFPWCxHQUFHLEVBQUUsQ0FBRSxNQUFNLElBQUljLEtBQUssQ0FBQyx1QkFBdUIsR0FBR25CLE9BQU8sQ0FBQ2tCLEdBQUcsQ0FBQyxDQUFFO0lBQ3RFLElBQUlsQixPQUFPLENBQUNvQixJQUFJLElBQUksRUFBRSxPQUFPcEIsT0FBTyxDQUFDb0IsSUFBSSxLQUFLLFFBQVEsSUFBSSxPQUFPcEIsT0FBTyxDQUFDb0IsSUFBSSxLQUFLLFFBQVEsQ0FBQyxFQUFFO01BQzNGLE1BQU0sSUFBSUQsS0FBSyxDQUFDLDJDQUEyQyxDQUFDO0lBQzlEOztJQUVBO0lBQ0EsSUFBSSxDQUFDN0IsVUFBVSxDQUFDTyxXQUFXLENBQUNHLE9BQU8sQ0FBQ2dCLElBQUksQ0FBQyxFQUFFMUIsVUFBVSxDQUFDTyxXQUFXLENBQUNHLE9BQU8sQ0FBQ2dCLElBQUksQ0FBQyxHQUFHLElBQUlLLG1CQUFVLENBQUMsQ0FBQyxDQUFDOztJQUVuRztJQUNBLElBQUksQ0FBQy9CLFVBQVUsQ0FBQ00saUJBQWlCLENBQUNJLE9BQU8sQ0FBQ2dCLElBQUksQ0FBQyxFQUFFO01BQy9DMUIsVUFBVSxDQUFDTSxpQkFBaUIsQ0FBQ0ksT0FBTyxDQUFDZ0IsSUFBSSxDQUFDLEdBQUcsSUFBSU0sd0JBQWUsQ0FBQztRQUMvREMsaUJBQWlCLEVBQUVqQyxVQUFVLENBQUNDLHVCQUF1QixFQUFFO1FBQ3ZEaUMscUJBQXFCLEVBQUVDO01BQ3pCLENBQUMsQ0FBQztJQUNKOztJQUVBO0lBQ0EsSUFBSUMsT0FBTyxHQUFHMUIsT0FBTyxDQUFDMEIsT0FBTyxLQUFLdEIsU0FBUyxHQUFHZCxVQUFVLENBQUNRLGVBQWUsR0FBR0UsT0FBTyxDQUFDMEIsT0FBTyxLQUFLLENBQUMsR0FBR3BDLFVBQVUsQ0FBQ1MsV0FBVyxHQUFHQyxPQUFPLENBQUMwQixPQUFPO0lBQzNJLElBQUlDLGNBQWMsR0FBR3JDLFVBQVUsQ0FBQ3NDLFlBQVksQ0FBQzVCLE9BQU8sQ0FBQztJQUNyRCxPQUFPNkIsaUJBQVEsQ0FBQ0Msa0JBQWtCLENBQUNILGNBQWMsRUFBRUQsT0FBTyxDQUFDO0VBQzdEOztFQUVBOzs7RUFHQTtBQUNGO0FBQ0E7QUFDQTtBQUNBO0VBQ0UsT0FBaUJLLFlBQVlBLENBQUEsRUFBRztJQUM5QixJQUFJLENBQUN6QyxVQUFVLENBQUMwQyxVQUFVLEVBQUUxQyxVQUFVLENBQUMwQyxVQUFVLEdBQUcsSUFBSUMsYUFBSSxDQUFDQyxLQUFLLENBQUM7TUFDakVDLFNBQVMsRUFBRSxJQUFJO01BQ2ZDLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDWixDQUFDLENBQUM7SUFDRixPQUFPOUMsVUFBVSxDQUFDMEMsVUFBVTtFQUM5Qjs7RUFFQTtBQUNGO0FBQ0E7QUFDQTtBQUNBO0VBQ0UsT0FBaUJLLGFBQWFBLENBQUEsRUFBRztJQUMvQixJQUFJLENBQUMvQyxVQUFVLENBQUNnRCxXQUFXLEVBQUVoRCxVQUFVLENBQUNnRCxXQUFXLEdBQUcsSUFBSUMsY0FBSyxDQUFDTCxLQUFLLENBQUM7TUFDcEVDLFNBQVMsRUFBRSxJQUFJO01BQ2ZDLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDWixDQUFDLENBQUM7SUFDRixPQUFPOUMsVUFBVSxDQUFDZ0QsV0FBVztFQUMvQjs7RUFFQSxhQUF1QlYsWUFBWUEsQ0FBQ1ksR0FBRyxFQUFFO0lBQ3ZDLElBQUlBLEdBQUcsQ0FBQ0MsT0FBTyxFQUFFLE1BQU0sSUFBSXRCLEtBQUssQ0FBQywrQ0FBK0MsQ0FBQyxDQUFDLENBQUU7O0lBRXBGO0lBQ0EsTUFBTTFCLE1BQU0sR0FBRytDLEdBQUcsQ0FBQy9DLE1BQU07SUFDekIsTUFBTXlCLEdBQUcsR0FBR3NCLEdBQUcsQ0FBQ3RCLEdBQUc7SUFDbkIsTUFBTUYsSUFBSSxHQUFHd0IsR0FBRyxDQUFDeEIsSUFBSTtJQUNyQixNQUFNMEIsUUFBUSxHQUFHRixHQUFHLENBQUNFLFFBQVE7SUFDN0IsTUFBTUMsUUFBUSxHQUFHSCxHQUFHLENBQUNHLFFBQVE7SUFDN0IsTUFBTXZCLElBQUksR0FBR29CLEdBQUcsQ0FBQ3BCLElBQUk7SUFDckIsTUFBTXdCLFFBQVEsR0FBR3hCLElBQUksWUFBWXlCLFVBQVU7O0lBRTNDO0lBQ0EsTUFBTUMsSUFBSSxHQUFHLE1BQU14RCxVQUFVLENBQUNPLFdBQVcsQ0FBQ21CLElBQUksQ0FBQyxDQUFDK0IsTUFBTSxDQUFDLGtCQUFpQjtNQUN0RSxPQUFPekQsVUFBVSxDQUFDTSxpQkFBaUIsQ0FBQ29CLElBQUksQ0FBQyxDQUFDZ0MsR0FBRyxDQUFDLFlBQVc7UUFDdkQsT0FBTyxJQUFJdkIsT0FBTyxDQUFDLFVBQVN3QixPQUFPLEVBQUVDLE1BQU0sRUFBRTtVQUMzQzVELFVBQVUsQ0FBQzZELHNCQUFzQixDQUFDMUQsTUFBTSxFQUFFeUIsR0FBRyxFQUFFd0IsUUFBUSxFQUFFQyxRQUFRLEVBQUV2QixJQUFJLENBQUMsQ0FBQ2dDLElBQUksQ0FBQyxVQUFTTixJQUFJLEVBQUU7WUFDM0ZHLE9BQU8sQ0FBQ0gsSUFBSSxDQUFDO1VBQ2YsQ0FBQyxDQUFDLENBQUNPLEtBQUssQ0FBQyxVQUFTQyxLQUFpQixFQUFFO1lBQ25DLElBQUlBLEtBQUssQ0FBQ0MsUUFBUSxFQUFFQyxNQUFNLEVBQUVQLE9BQU8sQ0FBQ0ssS0FBSyxDQUFDQyxRQUFRLENBQUM7WUFDbkRMLE1BQU0sQ0FBQyxJQUFJL0IsS0FBSyxDQUFDLG1DQUFtQyxHQUFHMUIsTUFBTSxHQUFHLEdBQUcsR0FBR3lCLEdBQUcsR0FBRyw2QkFBNkIsR0FBR29DLEtBQUssQ0FBQ2hELE9BQU8sR0FBRyxJQUFJLEdBQUdnRCxLQUFLLENBQUNHLEtBQUssQ0FBQyxDQUFDO1VBQ2xKLENBQUMsQ0FBQztRQUNKLENBQUMsQ0FBQzs7TUFFSixDQUFDLENBQUNDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNmLENBQUMsQ0FBQzs7SUFFRjtJQUNBLElBQUlDLGtCQUF1QixHQUFHLENBQUMsQ0FBQztJQUNoQ0Esa0JBQWtCLENBQUM5QyxVQUFVLEdBQUdpQyxJQUFJLENBQUNVLE1BQU07SUFDM0NHLGtCQUFrQixDQUFDQyxVQUFVLEdBQUdkLElBQUksQ0FBQ2MsVUFBVTtJQUMvQ0Qsa0JBQWtCLENBQUNsQixPQUFPLEdBQUcsRUFBQyxHQUFHSyxJQUFJLENBQUNMLE9BQU8sRUFBQztJQUM5Q2tCLGtCQUFrQixDQUFDdkMsSUFBSSxHQUFHd0IsUUFBUSxHQUFHLElBQUlDLFVBQVUsQ0FBQ0MsSUFBSSxDQUFDZSxJQUFJLENBQUMsR0FBR2YsSUFBSSxDQUFDZSxJQUFJO0lBQzFFLElBQUlGLGtCQUFrQixDQUFDdkMsSUFBSSxZQUFZMEMsV0FBVyxFQUFFSCxrQkFBa0IsQ0FBQ3ZDLElBQUksR0FBRyxJQUFJeUIsVUFBVSxDQUFDYyxrQkFBa0IsQ0FBQ3ZDLElBQUksQ0FBQyxDQUFDLENBQUU7SUFDeEgsT0FBT3VDLGtCQUFrQjtFQUMzQjs7RUFFQSxPQUFpQlIsc0JBQXNCLEdBQUcsZUFBQUEsQ0FBZTFELE1BQU0sRUFBRXNFLEdBQUcsRUFBRXJCLFFBQVEsRUFBRUMsUUFBUSxFQUFFdkIsSUFBSSxFQUFFO0lBQzlGLElBQUksT0FBTzRDLFFBQVEsS0FBSyxXQUFXLElBQUksT0FBT2pGLE9BQU8sS0FBSyxVQUFVLEVBQUU7TUFDcEUsSUFBSWlGLFFBQVEsR0FBR2pGLE9BQU8sQ0FBQyxXQUFXLENBQUM7SUFDckM7O0lBRUEsTUFBTWtGLGNBQWMsR0FBRyxTQUFBQSxDQUFBLEVBQW1CO01BQ3hDLE1BQU1DLFVBQVUsR0FBRyxrQkFBa0I7TUFDckMsSUFBSUMsS0FBSyxHQUFHLEVBQUU7TUFDZCxLQUFLLElBQUlDLENBQUMsR0FBRyxDQUFDLEVBQUVBLENBQUMsR0FBRyxFQUFFLEVBQUVBLENBQUMsRUFBRSxFQUFFO1FBQzNCLE1BQU1DLE9BQU8sR0FBR0MsSUFBSSxDQUFDQyxLQUFLLENBQUNELElBQUksQ0FBQ0UsTUFBTSxDQUFDLENBQUMsR0FBR04sVUFBVSxDQUFDM0QsTUFBTSxDQUFDO1FBQzdENEQsS0FBSyxJQUFJRCxVQUFVLENBQUNPLEtBQUssQ0FBQ0osT0FBTyxFQUFFQSxPQUFPLEdBQUMsQ0FBQyxDQUFDO01BQy9DO01BQ0EsT0FBT0YsS0FBSztJQUNkLENBQUM7O0lBRUQsSUFBSU8sS0FBSyxHQUFHLENBQUM7SUFDYixPQUFPQyxjQUFLLENBQUMzRSxPQUFPLENBQUM7TUFDbkIrRCxHQUFHLEVBQUVBLEdBQUc7TUFDUnRFLE1BQU0sRUFBRUEsTUFBTTtNQUNkaUMsT0FBTyxFQUFFLElBQUksQ0FBQ0EsT0FBTztNQUNyQmUsT0FBTyxFQUFFO1FBQ1AsY0FBYyxFQUFFO01BQ2xCLENBQUM7TUFDRG1DLFlBQVksRUFBRXhELElBQUksWUFBWXlCLFVBQVUsR0FBRyxhQUFhLEdBQUd6QyxTQUFTO01BQ3BFeUUsU0FBUyxFQUFFZCxHQUFHLENBQUNlLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRzFFLFNBQVMsR0FBR2QsVUFBVSxDQUFDeUMsWUFBWSxDQUFDLENBQUM7TUFDMUVnRCxVQUFVLEVBQUVoQixHQUFHLENBQUNlLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBR3hGLFVBQVUsQ0FBQytDLGFBQWEsQ0FBQyxDQUFDLEdBQUdqQyxTQUFTO01BQzVFeUQsSUFBSSxFQUFFekMsSUFBSTtNQUNWNEQsaUJBQWlCLEVBQUVBLENBQUFDLEdBQUcsS0FBSUEsR0FBRztNQUM3QkMsT0FBTyxFQUFFckQsaUJBQVEsQ0FBQ3NELE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsT0FBTztJQUNsRSxDQUFDLENBQUMsQ0FBQzlCLEtBQUssQ0FBQyxPQUFPaEQsR0FBRyxLQUFLO01BQ3RCLElBQUlBLEdBQUcsQ0FBQ2tELFFBQVEsRUFBRUMsTUFBTSxLQUFLLEdBQUcsRUFBRTtRQUNoQyxJQUFJNEIsVUFBVSxHQUFHL0UsR0FBRyxDQUFDa0QsUUFBUSxDQUFDZCxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQzRDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsRUFBRSxDQUFDO1FBQ3BGLElBQUksQ0FBQ0QsVUFBVSxFQUFFO1VBQ2YsTUFBTS9FLEdBQUc7UUFDWDs7UUFFQTtRQUNBLE1BQU1pRixhQUFhLEdBQUdGLFVBQVUsQ0FBQ0MsT0FBTyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQ0UsVUFBVSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQ0MsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDQyxNQUFNLENBQUMsQ0FBQ0MsSUFBSSxFQUFFQyxJQUFJLE1BQU0sRUFBQyxHQUFHRCxJQUFJLEVBQUUsQ0FBQ0MsSUFBSSxDQUFDSCxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUdHLElBQUksQ0FBQ0gsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDZixLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUNtQixJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDOztRQUV4TCxFQUFFbEIsS0FBSzs7UUFFUCxNQUFNbUIsTUFBTSxHQUFHNUIsY0FBYyxDQUFDLENBQUM7UUFDL0IsTUFBTTZCLEdBQUcsR0FBRzlCLFFBQVEsQ0FBQytCLEdBQUcsQ0FBQ3JELFFBQVEsR0FBQyxHQUFHLEdBQUM0QyxhQUFhLENBQUNVLEtBQUssR0FBQyxHQUFHLEdBQUNyRCxRQUFRLENBQUMsQ0FBQ3NELFFBQVEsQ0FBQyxDQUFDO1FBQ2xGLE1BQU1DLEdBQUcsR0FBR2xDLFFBQVEsQ0FBQytCLEdBQUcsQ0FBQ3RHLE1BQU0sR0FBQyxHQUFHLEdBQUNzRSxHQUFHLENBQUMsQ0FBQ2tDLFFBQVEsQ0FBQyxDQUFDOztRQUVuRCxNQUFNMUMsUUFBUSxHQUFHUyxRQUFRLENBQUMrQixHQUFHLENBQUNELEdBQUcsR0FBQyxHQUFHO1FBQ25DUixhQUFhLENBQUNhLEtBQUssR0FBQyxHQUFHO1FBQ3ZCLENBQUMsVUFBVSxHQUFHekIsS0FBSyxFQUFFRCxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxHQUFHO1FBQ2xDb0IsTUFBTSxHQUFDLEdBQUc7UUFDVlAsYUFBYSxDQUFDYyxHQUFHLEdBQUMsR0FBRztRQUNyQkYsR0FBRyxDQUFDLENBQUNELFFBQVEsQ0FBQyxDQUFDO1FBQ2pCLE1BQU1JLGdCQUFnQixHQUFHLFFBQVEsR0FBQyxHQUFHO1FBQ25DLFlBQVksR0FBQzNELFFBQVEsR0FBQyxLQUFLO1FBQzNCLFNBQVMsR0FBQzRDLGFBQWEsQ0FBQ1UsS0FBSyxHQUFDLEtBQUs7UUFDbkMsU0FBUyxHQUFDVixhQUFhLENBQUNhLEtBQUssR0FBQyxLQUFLO1FBQ25DLE9BQU8sR0FBQ3BDLEdBQUcsR0FBQyxLQUFLO1FBQ2pCLFlBQVksR0FBQ1IsUUFBUSxHQUFDLEtBQUs7UUFDM0IsVUFBVSxJQUFFK0IsYUFBYSxDQUFDZ0IsTUFBTSxJQUFJLElBQUksQ0FBQyxHQUFDLEtBQUs7UUFDL0MsTUFBTSxHQUFDaEIsYUFBYSxDQUFDYyxHQUFHLEdBQUMsSUFBSTtRQUM3QixLQUFLLEdBQUMsQ0FBQyxVQUFVLEdBQUcxQixLQUFLLEVBQUVELEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFDLElBQUk7UUFDekMsVUFBVSxHQUFDb0IsTUFBTSxHQUFDLEdBQUc7O1FBRXZCLE1BQU1VLGFBQWEsR0FBRyxNQUFNNUIsY0FBSyxDQUFDM0UsT0FBTyxDQUFDO1VBQ3hDK0QsR0FBRyxFQUFFQSxHQUFHO1VBQ1J0RSxNQUFNLEVBQUVBLE1BQU07VUFDZGlDLE9BQU8sRUFBRSxJQUFJLENBQUNBLE9BQU87VUFDckJlLE9BQU8sRUFBRTtZQUNQLGVBQWUsRUFBRTRELGdCQUFnQjtZQUNqQyxjQUFjLEVBQUU7VUFDbEIsQ0FBQztVQUNEekIsWUFBWSxFQUFFeEQsSUFBSSxZQUFZeUIsVUFBVSxHQUFHLGFBQWEsR0FBR3pDLFNBQVM7VUFDcEV5RSxTQUFTLEVBQUVkLEdBQUcsQ0FBQ2UsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHMUUsU0FBUyxHQUFHZCxVQUFVLENBQUN5QyxZQUFZLENBQUMsQ0FBQztVQUMxRWdELFVBQVUsRUFBRWhCLEdBQUcsQ0FBQ2UsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHeEYsVUFBVSxDQUFDK0MsYUFBYSxDQUFDLENBQUMsR0FBR2pDLFNBQVM7VUFDNUV5RCxJQUFJLEVBQUV6QyxJQUFJO1VBQ1Y0RCxpQkFBaUIsRUFBRUEsQ0FBQUMsR0FBRyxLQUFJQSxHQUFHO1VBQzdCQyxPQUFPLEVBQUVyRCxpQkFBUSxDQUFDc0QsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxPQUFPO1FBQ2xFLENBQUMsQ0FBQzs7UUFFRixPQUFPb0IsYUFBYTtNQUN0QjtNQUNBLE1BQU1sRyxHQUFHO0lBQ1gsQ0FBQyxDQUFDLENBQUNnRCxLQUFLLENBQUMsQ0FBQWhELEdBQUcsS0FBSTtNQUNkLE1BQU1BLEdBQUc7SUFDWCxDQUFDLENBQUM7RUFDSixDQUFDO0FBQ0gsQ0FBQ21HLE9BQUEsQ0FBQUMsT0FBQSxHQUFBbkgsVUFBQSJ9